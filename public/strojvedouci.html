<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strojvedouc√≠ | Multi-Cargo Doprava</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', Arial, sans-serif; background: #f7f8fa; color: #23272a; }
      #loginOverlay { position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.97);display:flex;align-items:center;justify-content:center;flex-direction:column; }
      #loginOverlay > div { background:#23272a;padding:36px 32px 28px 32px;border-radius:18px;box-shadow:0 8px 32px #0008;display:flex;flex-direction:column;align-items:center;min-width:320px; }
      #loginOverlay img { width:72px;height:72px;border-radius:16px;margin-bottom:18px;box-shadow:0 2px 8px #0006; }
      .discord-login-btn { background: linear-gradient(90deg, #6a8cff 0%, #a084ee 100%); color: #fff; border: none; border-radius: 9px; font-weight: 600; font-size: 1.15em; padding: 12px 32px; box-shadow: 0 2px 8px #6a8cff22; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; }
      .discord-login-btn:hover { background: linear-gradient(90deg, #4f6edb 0%, #a084ee 100%); box-shadow: 0 4px 16px #6a8cff33; }
      #userProfileBar { display: flex; align-items: center; justify-content: flex-end; padding: 8px 16px; background: #fff; border-bottom: 1px solid #eaeaea; }
      #userProfileBar img { width: 38px; height: 38px; border-radius: 50%; margin-right: 8px; }
      #userProfileBar span { font-size: 0.9rem; color: #23272a; }
    </style>
</head>
<body>
    <div id="loginOverlay" style="display:none;">
      <div>
        <img src="/logo.webp" alt="Logo">
        <h2 style="color:#fff;font-size:1.5em;margin-bottom:10px;">P≈ôihl√°≈°en√≠ do MCD</h2>
        <p style="color:#b9bbbe;font-size:1.08em;margin-bottom:22px;text-align:center;">Pro pokraƒçov√°n√≠ se p≈ôihla≈°te p≈ôes Discord.</p>
        <button id="discordLoginBtn" class="discord-login-btn" style="font-size:1.15em;padding:12px 32px;border-radius:9px;box-shadow:0 2px 8px #0004;">üîë P≈ôihl√°sit se p≈ôes Discord</button>
      </div>
    </div>
    <div id="userProfileBar" style="display:none;"></div>
    <header class="header-logo-title">
        <h1>Strojvedouc√≠ <span class="mcd-accent">MCD</span></h1>
        <div class="subtitle">P≈ôehled a spr√°va strojvedouc√≠ch spoleƒçnosti</div>
    </header>
    <div class="animated-bar"></div>
    <div class="main-rozcestnik">
      <div class="rozcestnik-palette">
        <button class="rozcestnik-toggle">‚ò∞ Otev≈ô√≠t rozcestn√≠k</button>
        <div class="rozcestnik-menu" style="display:none;">
          <a href="/strojvedouci.html" class="rozcestnik-link active">üë§ Strojvedouc√≠</a>
          <a href="/index.html" class="rozcestnik-link">üè† Dispeƒçink</a>
        </div>
      </div>
      <div class="rozcestnik-welcome">
        <h2>Strojvedouc√≠</h2>
        <p>Vyberte si akci:</p>
        <button id="discordLoginBtn" class="discord-login-btn" style="margin-bottom:18px;display:none;">üîë P≈ôihl√°sit se</button>
        <ul class="rozcestnik-list">
          <li><a href="#zamestnanci" class="rozcestnik-tile" onclick="document.getElementById('zamestnanciSection').scrollIntoView({behavior:'smooth'});return false;">üë§ Zamƒõstnanci</a></li>
          <li><a href="#pracovat" class="rozcestnik-tile" id="pracovatBtn">üíº Pracovat</a></li>
        </ul>
      </div>
    </div>
    <main class="main-center-panel" style="margin: 0 auto; max-width: 700px;">
        <section class="section" id="trainModalSection" style="display:none;">
            <!-- Sekce detailu vlaku a akce s vlaky byla odstranƒõna na p≈ô√°n√≠ u≈æivatele -->
        </section>
    </main>
    <!-- ODSTRANƒöNO: workModalOverlay (star√Ω modal v√Ωbƒõru serveru) -->
    <!-- ODSTRANƒöNO: p≈Øvodn√≠ tlaƒç√≠tko a widget "Slu≈æba" -->

    <!-- Doch√°zka embed (ponech√°n pouze jeden funkƒçn√≠ blok) -->
    <div id="dochazkaEmbed" style="display:none; position:fixed; top:110px; left:50%; transform:translateX(-50%); background:#fff; border-radius:14px; box-shadow:0 4px 24px #0057b822; padding:28px 18px 22px 18px; z-index:3000; min-width:220px; max-width:96vw;">
      <div style="font-size:1.18em; font-weight:600; margin-bottom:14px; text-align:center;">Moje doch√°zka</div>
      <div id="dochazkaActionStatus" style="min-height:22px; margin-bottom:10px; color:#0057b8; text-align:center;"></div>
      <div style="display:flex; gap:18px; justify-content:center;">
        <button id="dochazkaInBtn" style="padding:10px 22px; font-size:1.08em; border-radius:8px; border:none; background:#2ecc40; color:#fff; font-weight:600; cursor:pointer;">P≈ô√≠chod</button>
        <button id="dochazkaOutBtn" style="padding:10px 22px; font-size:1.08em; border-radius:8px; border:none; background:#e53935; color:#fff; font-weight:600; cursor:pointer;">Odchod</button>
      </div>
      <button id="closeDochazkaEmbed" style="position:absolute;top:10px;right:16px;background:none;border:none;font-size:1.3em;cursor:pointer;">&times;</button>
    </div>

    <!-- NOV√â: Tlaƒç√≠tko "Slu≈æba" a mal√Ω widget pro rychlou doch√°zku -->
    <button id="sluzbaBtn" class="rozcestnik-tile" style="margin-top:18px;position:fixed;bottom:32px;right:32px;z-index:2100;">üïí Slu≈æba</button>
    <div id="sluzbaWidget" style="display:none; position:fixed; bottom:80px; right:40px; background:#fff; border-radius:14px; box-shadow:0 4px 24px #0057b822; padding:22px 18px; z-index:2101; min-width:180px;">
      <div style="font-weight:600; margin-bottom:10px; text-align:center;">Doch√°zka</div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="empInBtn" style="padding:7px 16px; border-radius:7px; border:none; background:#2ecc40; color:#fff; font-weight:600; cursor:pointer;">P≈ô√≠chod</button>
        <button id="empOutBtn" style="padding:7px 16px; border-radius:7px; border:none; background:#e53935; color:#fff; font-weight:600; cursor:pointer;">Odchod</button>
      </div>
      <div id="actionStatusMessage" style="min-height:18px; margin-top:10px; font-size:0.97em; text-align:center;"></div>
    </div>

    <!-- Widget pro v√Ωbƒõr vlaku -->
    <div id="trainWidgetOverlay" style="display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;">
        <h2 style="margin-top:0;margin-bottom:18px;font-size:2em;color:#0057b8;">V√Ωbƒõr vlaku</h2>
        <div id="trainListModern" style="display:flex;gap:32px;justify-content:center;flex-wrap:wrap;width:100%;"></div>
        <button id="closeTrainWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div>

    <!-- Widget pro detail vlaku -->
    <div id="trainDetailWidgetOverlay" style="display:none;position:fixed;z-index:10001;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainDetailWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;position:relative;">
        <div id="trainDetailContent"></div>
        <button id="endRideBtn" style="margin-top:32px;padding:12px 32px;border-radius:10px;border:2px solid #e53935;background:#fff;color:#e53935;font-weight:600;font-size:1.1em;cursor:pointer;">TLAƒå√çTKO UKONƒåIT J√çZDU</button>
        <button id="closeTrainDetailWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // --- Discord login a user bar ---
        function isLoggedIn() {
          return localStorage.getItem('discordUser') !== null;
        }
        function showMainContent() {
          document.getElementById('loginOverlay').style.display = 'none';
          document.body.style.overflow = '';
        }
        function showLogin() {
          document.getElementById('loginOverlay').style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
        function saveDiscordUserFromUrl() {
          const params = new URLSearchParams(window.location.search);
          if(params.has('discordUser')) {
            try {
              const user = decodeURIComponent(params.get('discordUser'));
              localStorage.setItem('discordUser', user);
              window.history.replaceState({}, document.title, window.location.pathname);
              showMainContent();
            } catch(e) {}
          }
        }
        saveDiscordUserFromUrl();
        var userBar = document.getElementById('userProfileBar');
        var loginBtn = document.getElementById('discordLoginBtn');
        if(isLoggedIn()) {
          showMainContent();
          // Zobrazit user bar
          if(userBar) {
            userBar.style.display = 'flex';
            const userStr = localStorage.getItem('discordUser');
            let user = null;
            try { user = JSON.parse(userStr); } catch(e) {}
            if(user) {
              let avatarUrl = user.avatar
                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';
              userBar.innerHTML = `
                <img src="${avatarUrl}" alt="avatar" style="width:38px;height:38px;border-radius:50%;box-shadow:0 2px 8px #0002;">
                <span>${user.username}#${user.discriminator}</span>
              `;
            }
          }
          if(loginBtn) loginBtn.style.display = 'none';
        } else {
          showLogin();
          if(userBar) userBar.style.display = 'none';
          if(loginBtn) loginBtn.style.display = 'inline-block';
        }
        var btn = document.getElementById('discordLoginBtn');
        if(btn) {
          btn.addEventListener('click', function() {
            window.location.href = '/api/discord-login';
          });
        }

        // --- Rozcestn√≠k toggle ---
        var toggle = document.querySelector('.rozcestnik-toggle');
        var menu = document.querySelector('.rozcestnik-menu');
        if(toggle && menu) {
          toggle.addEventListener('click', function() {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
          });
          document.addEventListener('click', function(e) {
            if (!toggle.contains(e.target) && !menu.contains(e.target)) {
              menu.style.display = 'none';
            }
          });
        }

        // --- Doch√°zka embed ---
        var dochazkaBtn = document.getElementById('dochazkaBtn');
        var dochazkaEmbed = document.getElementById('dochazkaEmbed');
        var dochazkaInBtn = document.getElementById('dochazkaInBtn');
        var dochazkaOutBtn = document.getElementById('dochazkaOutBtn');
        var dochazkaActionStatus = document.getElementById('dochazkaActionStatus');
        var closeDochazkaEmbed = document.getElementById('closeDochazkaEmbed');

        if (dochazkaBtn && dochazkaEmbed) {
          dochazkaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            dochazkaEmbed.style.display = 'block';
            dochazkaActionStatus.textContent = '';
          });
        }
        if (closeDochazkaEmbed) {
          closeDochazkaEmbed.onclick = () => { dochazkaEmbed.style.display = 'none'; };
        }
        document.addEventListener('mousedown', function(e) {
          if (dochazkaEmbed.style.display === 'block' && !dochazkaEmbed.contains(e.target) && e.target !== dochazkaBtn) {
            dochazkaEmbed.style.display = 'none';
          }
        });

        // --- Funkce pro mal√Ω widget "Slu≈æba" ---
        const sluzbaBtn = document.getElementById('sluzbaBtn');
        const sluzbaWidget = document.getElementById('sluzbaWidget');
        const empInBtn = document.getElementById('empInBtn');
        const empOutBtn = document.getElementById('empOutBtn');
        const actionStatusMessage = document.getElementById('actionStatusMessage');

        if (sluzbaBtn && sluzbaWidget) {
          sluzbaBtn.onclick = () => {
            sluzbaWidget.style.display = sluzbaWidget.style.display === 'none' ? 'block' : 'none';
          };
          document.addEventListener('mousedown', function(e) {
            if (sluzbaWidget.style.display === 'block' && !sluzbaWidget.contains(e.target) && e.target !== sluzbaBtn) {
              sluzbaWidget.style.display = 'none';
            }
          });
        }

        async function sendDochazkaToDiscord(type, statusEl) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) {
            if (statusEl) {
              statusEl.textContent = 'Nejste p≈ôihl√°≈°en p≈ôes Discord.';
              statusEl.style.color = '#e53935';
            }
            return;
          }
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390845026375831552/Wf4OvVgDoV44X-e-11SMn5yskwHHh2-DyEUohAzu853kn5TD-6_RNRrIl8LSuGVTUC1S';
          const now = new Date();
          const timeStr = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
          const statusText = type === 'in' ? 'P≈ôi≈°el do slu≈æby' : 'Ode≈°el ze slu≈æby';
          const color = type === 'in' ? 0x2ecc40 : 0xe53935;
          const embed = {
            color,
            title: 'Doch√°zka',
            description: `**${user.username}** ${statusText} v ${timeStr}.`,
            timestamp: now.toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          try {
            const resp = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            if (resp.ok) {
              statusEl.textContent = `Status √∫spƒõ≈°nƒõ zmƒõnƒõn: ${statusText}.`;
              statusEl.style.color = '#2ecc40';
            } else {
              statusEl.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
              statusEl.style.color = '#e53935';
            }
          } catch (e) {
            statusEl.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
            statusEl.style.color = '#e53935';
          }
        }

        if (empInBtn) empInBtn.onclick = () => sendDochazkaToDiscord('in', actionStatusMessage);
        if (empOutBtn) empOutBtn.onclick = () => sendDochazkaToDiscord('out', actionStatusMessage);

        // --- Doch√°zka embed (velk√Ω) ---
        if (dochazkaInBtn) dochazkaInBtn.onclick = () => sendDochazkaToDiscord('in', dochazkaActionStatus);
        if (dochazkaOutBtn) dochazkaOutBtn.onclick = () => sendDochazkaToDiscord('out', dochazkaActionStatus);

        // --- MODERN√ç WIDGET PRO V√ùBƒöR VLAKU ---
        const pracovatBtn = document.getElementById('pracovatBtn');
        const trainWidgetOverlay = document.getElementById('trainWidgetOverlay');
        const trainWidget = document.getElementById('trainWidget');
        const trainListModern = document.getElementById('trainListModern');
        const closeTrainWidget = document.getElementById('closeTrainWidget');
        const trainDetailWidgetOverlay = document.getElementById('trainDetailWidgetOverlay');
        const trainDetailWidget = document.getElementById('trainDetailWidget');
        const trainDetailContent = document.getElementById('trainDetailContent');
        const endRideBtn = document.getElementById('endRideBtn');
        const closeTrainDetailWidget = document.getElementById('closeTrainDetailWidget');
        let selectedTrain = null;
        let updateInterval = null;

        if (pracovatBtn) {
          pracovatBtn.onclick = function() {
            showServerSelectModal(async function(server) {
              trainWidgetOverlay.style.display = 'flex';
              trainListModern.innerHTML = '<div style="color:#0057b8;">Naƒç√≠t√°m vlaky...</div>';
              closeTrainWidget.style.display = 'block';

              // Dynamicky zvol spr√°vn√© API podle serveru
              let apiServerCode = server.toLowerCase(); // INT1 ‚Üí int1, CZ1 ‚Üí cz1
              let trainsApi = `https://panel.simrail.eu:8084/trains-open?serverCode=${apiServerCode}`;

              try {
                const res = await fetch(trainsApi);
                let data = await res.json();
                if (!Array.isArray(data)) {
                  if (Array.isArray(data.trains)) data = data.trains;
                  else if (Array.isArray(data.data)) data = data.data;
                  else throw new Error('Neplatn√Ω form√°t dat z API');
                }
                const sorted = data
                  .filter(t => (t.TrainData?.VDDelayedTimetableIndex !== undefined))
                  .sort((a, b) => (a.TrainData.VDDelayedTimetableIndex ?? 9999) - (b.TrainData.VDDelayedTimetableIndex ?? 9999))
                  .slice(0, 4);
                trainListModern.innerHTML = '';
                sorted.forEach(train => {
                  const div = document.createElement('div');
                  div.style = 'background:#f7f8fa;border-radius:18px;padding:22px 18px;margin-bottom:10px;box-shadow:0 2px 8px #0057b822;display:flex;flex-direction:column;align-items:center;min-width:200px;max-width:220px;border:2px solid #0057b8;';
                  div.innerHTML = `
                    <div style="font-size:2.5em;color:#ff5733;margin-bottom:8px;">üöÜ</div>
                    <div style="font-size:1.5em;font-weight:600;color:#ff5733;margin-bottom:6px;">${train.TrainNoLocal}</div>
                    <div style="font-size:1.1em;color:#ff5733;margin-bottom:10px;">${train.StartStation} ‚Üí ${train.EndStation}</div>
                    <button class="takeTrainModernBtn" style="margin-top:10px;padding:10px 22px;border-radius:8px;border:2px solid #ff5733;background:#fff;color:#ff5733;font-weight:600;font-size:1.08em;cursor:pointer;">TLAƒå√çTKO P≈òEVZ√çT</button>
                  `;
                  div.querySelector('.takeTrainModernBtn').onclick = () => selectTrainModern(train);
                  trainListModern.appendChild(div);
                });
                if (sorted.length === 0) {
                  trainListModern.innerHTML = '<div style="color:#e53935;">≈Ω√°dn√© vlaky k dispozici.</div>';
                }
              } catch (e) {
                trainListModern.innerHTML = '<div style="color:#e53935;">Chyba p≈ôi naƒç√≠t√°n√≠ vlak≈Ø.<br>' + e + '</div>';
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ vlak≈Ø:', e);
              }
            });
          };
        }

        if (closeTrainWidget) {
          closeTrainWidget.onclick = () => {
            trainWidgetOverlay.style.display = 'none';
          };
        }

        async function selectTrainModern(train) {
          selectedTrain = train;
          trainWidgetOverlay.style.display = 'none';
          trainDetailWidgetOverlay.style.display = 'flex';
          closeTrainDetailWidget.style.display = 'none';
          renderTrainDetail(train);
          // Odeslat na Discord p≈ôevzet√≠
          sendTrainDiscord('take', train);
          // Aktualizace ƒçasu serveru ka≈æd√Ωch 10s (pouze ƒças, ne cel√Ω detail!)
          if (updateInterval) clearInterval(updateInterval);
          const updateServerTimeBtn = () => {
            const btn = document.getElementById('currentTimeBtn');
            if (!btn) return;
            btn.textContent = 'Naƒç√≠t√°m ƒças...';
            fetch('https://panel.simrail.eu:8084/server-time?serverCode=int1')
              .then(res => res.json())
              .then(data => {
                let timeStr = data.serverTime
                  ? new Date(data.serverTime).toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit',second:'2-digit'})
                  : 'Nelze naƒç√≠st ƒças';
                btn.textContent = 'Server: ' + timeStr;
              })
              .catch(() => {
                btn.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ ƒçasu';
              });
          };
          updateServerTimeBtn();
          updateInterval = setInterval(updateServerTimeBtn, 10000);
        }

        function renderTrainDetail(train) {
          trainDetailContent.innerHTML = `
            <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
              <div style="font-size:3em;color:#ff5733;">üöÜ</div>
              <div>
                <div style="font-size:2.2em;font-weight:600;color:#ff5733;">V√°≈° Vlak</div>
                <div style="font-size:1.3em;color:#ff5733;">${train.TrainNoLocal}</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;gap:32px;margin-bottom:18px;">
              <div style="font-size:1.5em;color:#ff5733;">${train.StartStation}</div>
              <div style="font-size:2em;">‚Üí</div>
              <div style="font-size:1.5em;color:#ff5733;">${train.EndStation}</div>
            </div>
            <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:18px;">
              <div style="color:#ff5733;">VOZIDLA<br><b>${(train.Vehicles || []).join(', ')}</b></div>
              <div style="color:#ff5733;">TYP<br><b>${train.TrainName || '-'}</b></div>
              <div style="color:#ff5733;">SERVER<br><b>${train.ServerCode || '-'}</b></div>
            </div>
            <button id="timetableBtn" style="position:absolute;top:32px;right:32px;padding:10px 28px;border-radius:8px;border:2px solid #0057b8;background:#fff;color:#0057b8;font-weight:600;font-size:1.08em;cursor:pointer;">J√≠zdn√≠ ≈ô√°d</button>
          `;
          closeTrainDetailWidget.style.display = 'block';
          document.getElementById('timetableBtn').onclick = () => renderTimetableWidget(train);
          // Oprava: funkƒçnost tlaƒç√≠tka "Ukonƒçit j√≠zdu"
          if (endRideBtn) {
            endRideBtn.onclick = async function() {
              trainDetailWidgetOverlay.style.display = 'none';
              closeTrainDetailWidget.style.display = 'none';
              // Odeslat na Discord ukonƒçen√≠ j√≠zdy
              await sendTrainDiscord('end', train);
            };
          }
          // Oprava: zav√≠r√°n√≠ detailu vlaku k≈ô√≠≈ækem
          if (closeTrainDetailWidget) {
            closeTrainDetailWidget.onclick = () => {
              trainDetailWidgetOverlay.style.display = 'none';
              closeTrainDetailWidget.style.display = 'none';
            };
          }
        }

        // Opraven√° funkce pro widget j√≠zdn√≠ho ≈ô√°du:
        function renderTimetableWidget(train) {
          // Pokud widget u≈æ existuje, sma≈æ ho
          let old = document.getElementById('timetableWidgetOverlay');
          if (old) old.remove();

          // Z√≠sk√°n√≠ j√≠zdn√≠ho ≈ô√°du z dat vlaku
          const timetable = (train.TrainData && Array.isArray(train.TrainData.VDTimetable)) ? train.TrainData.VDTimetable : [];
          const currentIndex = train.TrainData?.VDDelayedTimetableIndex ?? 0;
          const isBetween = !!train.TrainData?.VDIsBetweenStations;

          // Debug: vypi≈° do konzole, co je v j√≠zdn√≠m ≈ô√°du
          console.log('J√≠zdn√≠ ≈ô√°d:', timetable);

          let rows = '';
          if (timetable.length === 0) {
            rows = `<div style="color:#e53935;font-size:1.1em;text-align:center;margin:32px 0;">J√≠zdn√≠ ≈ô√°d nen√≠ k dispozici.</div>`;
          } else {
            for (let i = 0; i < timetable.length; i++) {
              const stop = timetable[i];
              let dot = '';
              // Zelen√° teƒçka na aktu√°ln√≠ stanici
              if (!isBetween && i === currentIndex) {
                dot = `<span class="blinking-dot"></span>`;
              }
              rows += `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                  ${dot}
                  <span style="font-size:1.12em;">${stop.StationName || stop.Name || stop.stationName || stop.name || '-'}</span>
                  <span style="color:#888;font-size:0.98em;margin-left:auto;">
                    ${stop.DepartureTime || stop.departureTime ? 'Odj. ' + (stop.DepartureTime || stop.departureTime) : (stop.ArrivalTime || stop.arrivalTime ? 'P≈ôij. ' + (stop.ArrivalTime || stop.arrivalTime) : '')}
                  </span>
                </div>
              `;
              // Pokud je mezi stanicemi, zobraz blikaj√≠c√≠ teƒçku mezi stanicemi
              if (isBetween && i === currentIndex) {
                rows += `
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;margin-left:18px;">
                    <span class="blinking-dot"></span>
                    <span style="font-size:1em;color:#888;">Mezi stanicemi</span>
                  </div>
                `;
              }
            }
          }

          // Vlo≈æ widget do DOM
          const overlay = document.createElement('div');
          overlay.id = 'timetableWidgetOverlay';
          overlay.style = 'position:fixed;z-index:10002;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);display:flex;align-items:center;justify-content:center;';
          overlay.innerHTML = `
            <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:320px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;">
              <h2 style="margin-top:0;margin-bottom:18px;font-size:1.5em;color:#0057b8;text-align:center;">J√≠zdn√≠ ≈ô√°d</h2>
              <div>${rows}</div>
              <button id="closeTimetableWidget" style="position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
            </div>
            <style>
              .blinking-dot {
                display:inline-block;
                width:16px;
                height:16px;
                border-radius:50%;
                background:#2ecc40;
                margin-right:4px;
                animation: blink 1s infinite;
                box-shadow:0 0 8px #2ecc40;
              }
              @keyframes blink {
                0%,100% { opacity: 1; }
                50% { opacity: 0.2; }
              }
            </style>
          `;
          document.body.appendChild(overlay);
          document.getElementById('closeTimetableWidget').onclick = () => overlay.remove();
        }

        async function sendTrainDiscord(action, train) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) return;
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390989690072727605/IwgaE5140eg1RVJuIgC8hmjGpi-IhC5pYCAzRJqstgtFVkuzQ8YadyR4TWhXC9UysbMv';
          let embed;
          if (action === 'take') {
            embed = {
              color: 0x0057b8,
              title: 'üöÜ P≈ôevzet√≠ vlaku',
              description: `**${user.username}** si pr√°vƒõ p≈ôevzal vlak **${train.TrainNoLocal}** z **${train.StartStation}** do **${train.EndStation}**.`,
              timestamp: new Date().toISOString(),
              footer: { text: 'Multi-Cargo Doprava' }
            };
          } else {
            embed = {
              color: 0xe53935,
              title: 'üõë Ukonƒçen√≠ j√≠zdy',
              description: `**${user.username}** pr√°vƒõ ukonƒçil j√≠zdu vlaku **${train.TrainNoLocal}** z **${train.StartStation}** do **${train.EndStation}**.`,
              timestamp: new Date().toISOString(),
              footer: { text: 'Multi-Cargo Doprava' }
            };
          }
          await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds: [embed] })
          });
        }

        // --- Widget pro Statistiky zamƒõstnanc≈Ø se zlat√Ωm r√°meƒçkem ---
        (function() {
          // Najdi tlaƒç√≠tko Zamƒõstnanci (podle href nebo textu)
          const zamestnanciBtn = Array.from(document.querySelectorAll('a.rozcestnik-tile')).find(a =>
            a.textContent.includes('Zamƒõstnanci')
          );
          let zamestnanciOverlay = null;

          // Statistiky v localStorage podle u≈æivatelsk√©ho ID
          function getStats(userId) {
            const stats = JSON.parse(localStorage.getItem('mcdStats') || '{}');
            return stats[userId] || { rides: 0, time: 0 };
          }
          function setStats(userId, data) {
            const stats = JSON.parse(localStorage.getItem('mcdStats') || '{}');
            stats[userId] = data;
            localStorage.setItem('mcdStats', JSON.stringify(stats));
          }
          function formatTime(sec) {
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            return `${h}h ${m}m`;
          }

          function getAllStats() {
            // Pro demo: seznam zamƒõstnanc≈Ø (m≈Ø≈æe≈° roz≈°√≠≈ôit)
            const knownUsers = [
              { id: "417061947759001600", name: "kubiasofficial" },
              { id: "1350594297250185331", name: "Va≈°√≠ƒçek_Andrejka" }
            ];
            // Naƒçti statistiky z localStorage
            const stats = JSON.parse(localStorage.getItem('mcdStats') || '{}');
            // Sestav pole pro ≈æeb≈ô√≠ƒçek
            return knownUsers.map(u => ({
              id: u.id,
              name: u.name,
              rides: stats[u.id]?.rides || 0,
              time: stats[u.id]?.time || 0
            })).sort((a, b) => b.rides - a.rides || b.time - a.time);
          }

          function openZamestnanciWidget() {
            // Z√≠sk√°n√≠ aktu√°lnƒõ p≈ôihl√°≈°en√©ho u≈æivatele
            let user = null;
            try { user = JSON.parse(localStorage.getItem('discordUser')); } catch(e) {}

            // Z√≠sk√°n√≠ informac√≠ o p≈ôevzat√©m vlaku z localStorage
            let trainInfo = JSON.parse(localStorage.getItem('mcdCurrentTrain') || 'null');

            // P≈ôiprav pole u≈æivatel≈Ø (zat√≠m jen aktu√°ln√≠ u≈æivatel)
            let users = [];
            if (user) {
              users.push({
                name: user.username,
                route: trainInfo ? `${trainInfo.StartStation} ‚Üí ${trainInfo.EndStation}` : '-',
                trainNo: trainInfo ? trainInfo.TrainNoLocal : '-'
              });
            }

            // ≈Ωeb≈ô√≠ƒçek
            const leaderboard = getAllStats();

            let html = `<h2 style="margin-top:0;margin-bottom:18px;font-size:1.5em;color:#bfa13a;text-align:center;">Aktu√°lnƒõ p≈ôihl√°≈°en√≠ zamƒõstnanci</h2>`;
            html += `
              <table style="width:100%;border-collapse:collapse;margin-bottom:32px;">
                <thead>
                  <tr style="background:#f7f8fa;">
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">Zamƒõstnanec</th>
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">Trasa</th>
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">ƒå√≠slo vlaku</th>
                  </tr>
                </thead>
                <tbody>
                  ${users.map(u => `
                    <tr>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${u.name}</td>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${u.route}</td>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${u.trainNo}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              <h2 style="margin-top:0;margin-bottom:14px;font-size:1.25em;color:#bfa13a;text-align:center;">≈Ωeb≈ô√≠ƒçek strojvedouc√≠ch</h2>
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:#f7f8fa;">
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">Po≈ôad√≠</th>
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">Jm√©no</th>
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">Trasy</th>
                    <th style="padding:8px 6px;border-bottom:2px solid #bfa13a;text-align:left;">ƒåas na ≈æeleznici</th>
                  </tr>
                </thead>
                <tbody>
                  ${leaderboard.map((u, i) => `
                    <tr${user && user.username === u.name ? ' style="background:#fffbe6;"' : ''}>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${i + 1}.</td>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${u.name}</td>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${u.rides}</td>
                      <td style="padding:7px 6px;border-bottom:1px solid #eee;">${formatTime(u.time)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;

            // Overlay se zlat√Ωm r√°meƒçkem a zaoblen√Ωmi hranami
            if (window.zamestnanciOverlay) window.zamestnanciOverlay.remove();
            window.zamestnanciOverlay = document.createElement('div');
            window.zamestnanciOverlay.id = 'zamestnanciOverlay';
            window.zamestnanciOverlay.style = 'position:fixed;z-index:10010;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);display:flex;align-items:center;justify-content:center;';
            window.zamestnanciOverlay.innerHTML = `
              <div style="background:#fff;padding:36px 32px 28px 32px;border-radius:32px;box-shadow:0 8px 32px #bfa13a88;min-width:320px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;border:5px solid #bfa13a;">
                ${html}
                <button id="closeZamestnanciWidget" style="position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#bfa13a;">&times;</button>
              </div>
            `;
            document.body.appendChild(window.zamestnanciOverlay);
            document.getElementById('closeZamestnanciWidget').onclick = () => window.zamestnanciOverlay.remove();
          }

          if (zamestnanciBtn) {
            zamestnanciBtn.addEventListener('click', function(e) {
              e.preventDefault();
              openZamestnanciWidget();
            });
          }

          // --- Logika pro poƒç√≠t√°n√≠ tras a ƒçasu ---
          let rideStartTime = null;
          let rideUserId = null;

          // Ulo≈æ si p≈Øvodn√≠ funkci selectTrainModern, pokud u≈æ existuje
          const origSelectTrainModern = window.selectTrainModern;
          window.selectTrainModern = async function(train) {
            if (typeof origSelectTrainModern === "function") await origSelectTrainModern(train);
            // Zaƒçni mƒõ≈ôit ƒças pro aktu√°ln√≠ho u≈æivatele
            let user = null;
            try { user = JSON.parse(localStorage.getItem('discordUser')); } catch(e) {}
            if (user) {
              rideStartTime = Date.now();
              rideUserId = user.id;
            }
            // Ulo≈æ aktu√°ln√≠ vlak do localStorage
            localStorage.setItem('mcdCurrentTrain', JSON.stringify(train));
          };

          // Ulo≈æ si p≈Øvodn√≠ funkci endRideBtn.onclick, pokud u≈æ existuje
          const endRideBtn = window.endRideBtn || document.getElementById('endRideBtn');
          if (endRideBtn) {
            const origEndRide = endRideBtn.onclick;
            endRideBtn.onclick = async function() {
              if (typeof origEndRide === "function") await origEndRide();
              // Ulo≈æ statistiku
              let user = null;
              try { user = JSON.parse(localStorage.getItem('discordUser')); } catch(e) {}
              if (user && rideStartTime && rideUserId === user.id) {
                const stats = getStats(user.id);
                stats.rides += 1;
                stats.time += Math.floor((Date.now() - rideStartTime) / 1000);
                setStats(user.id, stats);
                rideStartTime = null;
                rideUserId = null;
              }
              // Sma≈æ info o aktu√°ln√≠m vlaku
              localStorage.removeItem('mcdCurrentTrain');
            };
          }
        })();

        (function() {
          // --- MODAL pro v√Ωbƒõr serveru ---
          function showServerSelectModal(onSelect) {
            // Pokud u≈æ modal existuje, sma≈æ ho
            let old = document.getElementById('serverSelectModal');
            if (old) old.remove();

            const modal = document.createElement('div');
            modal.id = 'serverSelectModal';
            modal.style = 'position:fixed;z-index:10020;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
              <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #bfa13a88;min-width:320px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;">
                <h2 style="margin-top:0;margin-bottom:18px;font-size:1.35em;color:#0057b8;text-align:center;">Vyber server</h2>
                <div style="display:flex;gap:18px;justify-content:center;">
                  <button class="serverBtn" data-server="INT1" style="padding:12px 28px;font-size:1.13em;border-radius:10px;border:2px solid #0057b8;background:#f7f8fa;color:#0057b8;font-weight:600;cursor:pointer;">INT1</button>
                  <button class="serverBtn" data-server="CZ1" style="padding:12px 28px;font-size:1.13em;border-radius:10px;border:2px solid #bfa13a;background:#f7f8fa;color:#bfa13a;font-weight:600;cursor:pointer;">CZ1</button>
                </div>
                <button id="closeServerSelectModal" style="position:absolute;top:14px;right:22px;background:none;border:none;font-size:2em;cursor:pointer;color:#0057b8;">&times;</button>
              </div>
            `;
            document.body.appendChild(modal);

            // Handler na v√Ωbƒõr serveru
            modal.querySelectorAll('.serverBtn').forEach(btn => {
              btn.onclick = () => {
                const server = btn.getAttribute('data-server');
                modal.remove();
                onSelect(server);
              };
            });
            document.getElementById('closeServerSelectModal').onclick = () => modal.remove();
          }

          // --- √öPRAVA tlaƒç√≠tka Pracovat ---
          const pracovatBtn = document.getElementById('pracovatBtn');
          if (pracovatBtn) {
            pracovatBtn.addEventListener('click', function(e) {
              e.preventDefault();
              showServerSelectModal(async function(server) {
                // Zde si nastav promƒõnnou serveru (nap≈ô. window.selectedServer)
                window.selectedServer = server;
                // Pot√© spus≈• p≈Øvodn√≠ logiku pro zobrazen√≠ vlak≈Ø
                // Pokud m√°≈° funkci na zobrazen√≠ vlak≈Ø, p≈ôedej j√≠ server:
                // nap≈ô. showTrainList(server);
                // Pokud naƒç√≠t√°≈° vlaky p≈ôes fetch, pou≈æij spr√°vn√© API:
                // INT1: p≈Øvodn√≠ API, CZ1: https://panel.simrail.eu:8084/servers-open
                // ...zbytek tv√© logiky...
              });
            });
          }

          // --- P≈ô√≠klad jak naƒç√≠tat vlaky podle serveru ---
          async function fetchTrains(server) {
            if (server === "CZ1") {
              // CZ-1 API
              const res = await fetch("https://panel.simrail.eu:8084/servers-open");
              return await res.json();
            } else {
              // INT1 - p≈Øvodn√≠ logika
              // return await fetch(...);
            }
          }

          // D√°le ve tv√© logice pro zobrazen√≠ vlak≈Ø pou≈æij window.selectedServer a fetchTrains(window.selectedServer)
        })();
      });
    </script>
    <footer class="footer">
        &copy; 2025 Multi-Cargo Doprava (MCD) &mdash; str√°nka strojvedouc√≠ch
    </footer>

    <!-- Modal pro v√Ωbƒõr serveru a vlaku (p≈ôesunuto na konec body) -->
    <!-- <div id="workModalOverlay" style="display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="workModal" style="background:#fff;padding:32px 28px 24px 28px;border-radius:18px;box-shadow:0 8px 32px #0008;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;display:flex;flex-direction:column;align-items:center;">
        <h2 style="margin-top:0;margin-bottom:18px;font-size:1.35em;">V√Ωbƒõr serveru</h2>
        <div id="serverList" style="display:flex;flex-wrap:wrap;gap:12px 18px;margin-bottom:24px;justify-content:center;align-items:center;min-height:60px;font-size:1.13em;color:#0057b8;font-weight:600;">
          Na √∫pravƒõ se aktu√°lnƒõ pracuje.
        </div>
        <div id="trainListSection" style="display:none;width:100%;">
          <h3 style="margin-bottom:12px;font-size:1.13em;">V√Ωbƒõr vlaku</h3>
          <div id="trainList" style="max-height:320px;overflow-y:auto;"></div>
        </div>
        <div id="selectedTrainSection" style="display:none;margin-top:18px;text-align:center;width:100%;">
          <div id="selectedTrainInfo" style="margin-bottom:14px;"></div>
          <button id="takeTrainBtn" class="discord-login-btn" style="margin-right:12px;">üöÜ P≈ôevz√≠t</button>
          <button id="endTrainBtn" class="duty-red">üõë Ukonƒçit j√≠zdu</button>
        </div>
        <button id="closeWorkModal" style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:1.5em;cursor:pointer;">&times;</button>
      </div>
    </div> -->

    <!-- Tlaƒç√≠tko "Slu≈æba" (m≈Ø≈æe≈° ho um√≠stit do rozcestn√≠ku nebo kam pot≈ôebuje≈°) -->
    <!-- <button id="sluzbaBtn" class="rozcestnik-tile" style="margin-top:18px;">üïí Slu≈æba</button> -->

    <!-- Mal√Ω widget pro p≈ô√≠chod/odchod, zobrazuje se a≈æ po kliknut√≠ na tlaƒç√≠tko "Slu≈æba" -->
    <!-- <div id="sluzbaWidget" style="display:none; position:fixed; top:90px; right:40px; background:#fff; border-radius:12px; box-shadow:0 4px 24px #0057b822; padding:22px 18px; z-index:2000; min-width:180px;">
      <div style="font-weight:600; margin-bottom:10px; text-align:center;">Doch√°zka</div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="empInBtn" style="padding:7px 16px; border-radius:7px; border:none; background:#2ecc40; color:#fff; font-weight:600; cursor:pointer;">P≈ô√≠chod</button>
        <button id="empOutBtn" style="padding:7px 16px; border-radius:7px; border:none; background:#e53935; color:#fff; font-weight:600; cursor:pointer;">Odchod</button>
      </div>
      <div id="actionStatusMessage" style="min-height:18px; margin-top:10px; font-size:0.97em; text-align:center;"></div>
    </div> -->

    <!-- Widget pro v√Ωbƒõr vlaku -->
    <!-- <div id="trainWidgetOverlay" style="display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;">
        <h2 style="margin-top:0;margin-bottom:18px;font-size:2em;color:#0057b8;">V√Ωbƒõr vlaku</h2>
        <div id="trainListModern" style="display:flex;gap:32px;justify-content:center;flex-wrap:wrap;width:100%;"></div>
        <button id="closeTrainWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div> -->

    <!-- Widget pro detail vlaku -->
    <!-- <div id="trainDetailWidgetOverlay" style="display:none;position:fixed;z-index:10001;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainDetailWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;position:relative;">
        <div id="trainDetailContent"></div>
        <button id="endRideBtn" style="margin-top:32px;padding:12px 32px;border-radius:10px;border:2px solid #e53935;background:#fff;color:#e53935;font-weight:600;font-size:1.1em;cursor:pointer;">TLAƒå√çTKO UKONƒåIT J√çZDU</button>
        <button id="closeTrainDetailWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div> -->
</body>
</html>
