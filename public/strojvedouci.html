<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strojvedouc√≠ | Multi-Cargo Doprava</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', Arial, sans-serif; background: #f7f8fa; color: #23272a; }
      #loginOverlay { position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.97);display:flex;align-items:center;justify-content:center;flex-direction:column; }
      #loginOverlay > div { background:#23272a;padding:36px 32px 28px 32px;border-radius:18px;box-shadow:0 8px 32px #0008;display:flex;flex-direction:column;align-items:center;min-width:320px; }
      #loginOverlay img { width:72px;height:72px;border-radius:16px;margin-bottom:18px;box-shadow:0 2px 8px #0006; }
      .discord-login-btn { background: linear-gradient(90deg, #6a8cff 0%, #a084ee 100%); color: #fff; border: none; border-radius: 9px; font-weight: 600; font-size: 1.15em; padding: 12px 32px; box-shadow: 0 2px 8px #6a8cff22; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; }
      .discord-login-btn:hover { background: linear-gradient(90deg, #4f6edb 0%, #a084ee 100%); box-shadow: 0 4px 16px #6a8cff33; }
      #userProfileBar { display: flex; align-items: center; justify-content: flex-end; padding: 8px 16px; background: #fff; border-bottom: 1px solid #eaeaea; }
      #userProfileBar img { width: 38px; height: 38px; border-radius: 50%; margin-right: 8px; }
      #userProfileBar span { font-size: 0.9rem; color: #23272a; }
    </style>
</head>
<body>
    <div id="loginOverlay" style="display:none;">
      <div>
        <img src="/logo.webp" alt="Logo">
        <h2 style="color:#fff;font-size:1.5em;margin-bottom:10px;">P≈ôihl√°≈°en√≠ do MCD</h2>
        <p style="color:#b9bbbe;font-size:1.08em;margin-bottom:22px;text-align:center;">Pro pokraƒçov√°n√≠ se p≈ôihla≈°te p≈ôes Discord.</p>
        <button id="discordLoginBtn" class="discord-login-btn" style="font-size:1.15em;padding:12px 32px;border-radius:9px;box-shadow:0 2px 8px #0004;">üîë P≈ôihl√°sit se p≈ôes Discord</button>
      </div>
    </div>
    <div id="userProfileBar" style="display:none;"></div>
    <header class="header-logo-title">
        <h1>Strojvedouc√≠ <span class="mcd-accent">MCD</span></h1>
        <div class="subtitle">P≈ôehled a spr√°va strojvedouc√≠ch spoleƒçnosti</div>
    </header>
    <div class="animated-bar"></div>
    <div class="main-rozcestnik">
      <div class="rozcestnik-palette">
        <button class="rozcestnik-toggle">‚ò∞ Otev≈ô√≠t rozcestn√≠k</button>
        <div class="rozcestnik-menu" style="display:none;">
          <a href="/strojvedouci.html" class="rozcestnik-link active">üë§ Strojvedouc√≠</a>
          <a href="/index.html" class="rozcestnik-link">üè† Dispeƒçink</a>
        </div>
      </div>
      <div class="rozcestnik-welcome">
        <h2>Strojvedouc√≠</h2>
        <p>Vyberte si akci:</p>
        <button id="discordLoginBtn" class="discord-login-btn" style="margin-bottom:18px;display:none;">üîë P≈ôihl√°sit se</button>
        <ul class="rozcestnik-list">
          <li><a href="#dochazka" class="rozcestnik-tile" id="dochazkaBtn">üïí Doch√°zka</a></li>
          <li><a href="#zamestnanci" class="rozcestnik-tile" onclick="document.getElementById('zamestnanciSection').scrollIntoView({behavior:'smooth'});return false;">üë§ Zamƒõstnanci</a></li>
          <li><a href="#pracovat" class="rozcestnik-tile" id="pracovatBtn">üíº Pracovat</a></li>
        </ul>
      </div>
    </div>
    <main class="main-center-panel" style="margin: 0 auto; max-width: 700px;">
        <section id="driversSection" class="section" style="margin-top: 32px; text-align: center;">
            <h2>Seznam strojvedouc√≠ch</h2>
            <div id="driversList" style="margin-top: 24px;"></div>
        </section>
        <section id="zamestnanciSection" class="section" style="margin-top: 32px; text-align: center;">
            <h2>Moje doch√°zka</h2>
            <!-- Embed s doch√°zkou je nyn√≠ naho≈ôe, zde u≈æ nen√≠ pot≈ôeba -->
        </section>



        <section class="section" id="trainModalSection" style="display:none;">
            <!-- Sekce detailu vlaku a akce s vlaky byla odstranƒõna na p≈ô√°n√≠ u≈æivatele -->
        </section>
    </main>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // --- Pracovat modal ---
        const pracovatBtn = document.getElementById('pracovatBtn');
        const workModalOverlay = document.getElementById('workModalOverlay');
        const closeWorkModal = document.getElementById('closeWorkModal');
        const serverList = document.getElementById('serverList');
        const trainListSection = document.getElementById('trainListSection');
        const trainList = document.getElementById('trainList');
        const selectedTrainSection = document.getElementById('selectedTrainSection');
        const selectedTrainInfo = document.getElementById('selectedTrainInfo');
        const takeTrainBtn = document.getElementById('takeTrainBtn');
        const endTrainBtn = document.getElementById('endTrainBtn');
        let selectedServer = null;
        let selectedTrain = null;

        if(pracovatBtn) {
          pracovatBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openWorkModal();
          });
        }
        if(closeWorkModal) closeWorkModal.onclick = () => { workModalOverlay.style.display = 'none'; resetWorkModal(); };

        function openWorkModal() {
          workModalOverlay.style.display = 'flex';
          resetWorkModal();
          fetchServers();
        }
        function resetWorkModal() {
          serverList.innerHTML = '';
          trainListSection.style.display = 'none';
          trainList.innerHTML = '';
          selectedTrainSection.style.display = 'none';
          selectedTrain = null;
          selectedServer = null;
        }

        async function fetchServers() {
          // Z√≠sk√°n√≠ server≈Ø z API
          try {
            const res = await fetch('https://simrail.live-map.workers.dev/cs/servers');
            const data = await res.json();
            renderServerList(data);
          } catch(e) {
            serverList.innerHTML = '<div style="color:#e53935;">Chyba p≈ôi naƒç√≠t√°n√≠ server≈Ø.</div>';
          }
        }
        function renderServerList(servers) {
          serverList.innerHTML = '';
          servers.forEach(server => {
            const btn = document.createElement('button');
            btn.textContent = `${server.name} (${server.region})`;
            btn.className = 'discord-login-btn';
            btn.style.marginBottom = '0';
            btn.onclick = () => selectServer(server);
            serverList.appendChild(btn);
          });
        }
        async function selectServer(server) {
          selectedServer = server;
          trainListSection.style.display = 'block';
          trainList.innerHTML = '<div>Naƒç√≠t√°m vlaky...</div>';
          selectedTrainSection.style.display = 'none';
          try {
            const res = await fetch(`https://simrail.live-map.workers.dev/cs/trains?server=${encodeURIComponent(server.id)}`);
            const data = await res.json();
            renderTrainList(data);
          } catch(e) {
            trainList.innerHTML = '<div style="color:#e53935;">Chyba p≈ôi naƒç√≠t√°n√≠ vlak≈Ø.</div>';
          }
        }
        function renderTrainList(trains) {
          trainList.innerHTML = '';
          trains.forEach(train => {
            const div = document.createElement('div');
            div.className = 'train-tile';
            div.style = 'background:#f7f8fa;border-radius:12px;padding:14px 12px;margin-bottom:10px;box-shadow:0 2px 8px #0057b822;cursor:pointer;display:flex;align-items:center;justify-content:space-between;';
            div.innerHTML = `
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:1.3em;">üöÜ</span>
                <div>
                  <div style="font-weight:600;">${train.number} ${train.name || ''}</div>
                  <div style="font-size:0.98em;color:#555;">${train.from} ‚Üí ${train.to}</div>
                  <div style="font-size:0.93em;color:#888;">${train.status === 'active' ? 'Na mapƒõ' : `Spawn za ${train.spawnIn} min (${train.spawnTime})`}</div>
                </div>
              </div>
              <div style="font-size:0.95em;color:#0057b8;font-weight:600;">${train.type || ''}</div>
            `;
            div.onclick = () => selectTrain(train);
            trainList.appendChild(div);
          });
        }
        function selectTrain(train) {
          selectedTrain = train;
          selectedTrainSection.style.display = 'block';
          selectedTrainInfo.innerHTML = `
            <div style="font-size:1.1em;font-weight:600;">${train.number} ${train.name || ''}</div>
            <div style="font-size:0.98em;color:#555;">${train.from} ‚Üí ${train.to}</div>
            <div style="font-size:0.93em;color:#888;">${train.status === 'active' ? 'Na mapƒõ' : `Spawn za ${train.spawnIn} min (${train.spawnTime})`}</div>
          `;
        }
        if(takeTrainBtn) takeTrainBtn.onclick = async function() {
          if(!selectedTrain || !selectedServer) return;
          const userStr = localStorage.getItem('discordUser');
          if(!userStr) return;
          let user;
          try { user = JSON.parse(userStr); } catch(e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390989690072727605/IwgaE5140eg1RVJuIgC8hmjGpi-IhC5pYCAzRJqstgtFVkuzQ8YadyR4TWhXC9UysbMv';
          const embed = {
            color: 0x0057b8,
            title: 'üöÜ P≈ôevzet√≠ vlaku',
            description: `**${user.username}** si pr√°vƒõ p≈ôevzal vlak **${selectedTrain.number}** z **${selectedTrain.from}** do **${selectedTrain.to}** na serveru **${selectedServer.name}**.`,
            timestamp: new Date().toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds: [embed] })
          });
          takeTrainBtn.disabled = true;
          endTrainBtn.disabled = false;
        };
        if(endTrainBtn) endTrainBtn.onclick = async function() {
          if(!selectedTrain || !selectedServer) return;
          const userStr = localStorage.getItem('discordUser');
          if(!userStr) return;
          let user;
          try { user = JSON.parse(userStr); } catch(e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390989690072727605/IwgaE5140eg1RVJuIgC8hmjGpi-IhC5pYCAzRJqstgtFVkuzQ8YadyR4TWhXC9UysbMv';
          const embed = {
            color: 0xe53935,
            title: 'üõë Ukonƒçen√≠ j√≠zdy',
            description: `**${user.username}** pr√°vƒõ ukonƒçil j√≠zdu vlaku **${selectedTrain.number}** z **${selectedTrain.from}** do **${selectedTrain.to}** na serveru **${selectedServer.name}**.`,
            timestamp: new Date().toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds: [embed] })
          });
          endTrainBtn.disabled = true;
          takeTrainBtn.disabled = false;
        };

        // --- Glob√°ln√≠ p≈ôihl√°≈°en√≠ p≈ôes Discord (stejn√© jako na index.html) ---
        function isLoggedIn() {
          return localStorage.getItem('discordUser') !== null;
        }
        function showMainContent() {
          document.getElementById('loginOverlay').style.display = 'none';
          document.body.style.overflow = '';
        }
        function showLogin() {
          document.getElementById('loginOverlay').style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
        function saveDiscordUserFromUrl() {
          const params = new URLSearchParams(window.location.search);
          if(params.has('discordUser')) {
            try {
              const user = decodeURIComponent(params.get('discordUser'));
              localStorage.setItem('discordUser', user);
              window.history.replaceState({}, document.title, window.location.pathname);
              showMainContent();
            } catch(e) {}
          }
        }
        saveDiscordUserFromUrl();
        var userBar = document.getElementById('userProfileBar');
        var loginBtn = document.getElementById('discordLoginBtn');
        var dochazkaBtn = document.getElementById('dochazkaBtn');
        var dochazkaEmbed = document.getElementById('dochazkaEmbed');
        var empInBtn = document.getElementById('empInBtn');
        var empOutBtn = document.getElementById('empOutBtn');
        var actionStatusMessage = document.getElementById('actionStatusMessage');
        if(isLoggedIn()) {
          showMainContent();
          // Zobrazit user bar
          if(userBar) {
            userBar.style.display = 'flex';
            const userStr = localStorage.getItem('discordUser');
            let user = null;
            try { user = JSON.parse(userStr); } catch(e) {}
            if(user) {
              let avatarUrl = user.avatar
                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';
              userBar.innerHTML = `
                <img src="${avatarUrl}" alt="avatar" style="width:38px;height:38px;border-radius:50%;box-shadow:0 2px 8px #0002;">
                <span>${user.username}#${user.discriminator}</span>
              `;
            }
          }
          // Skryt√≠ tlaƒç√≠tka P≈ôihl√°sit se
          if(loginBtn) loginBtn.style.display = 'none';
        } else {
          showLogin();
          if(userBar) userBar.style.display = 'none';
          if(loginBtn) loginBtn.style.display = 'inline-block';
        }
        var btn = document.getElementById('discordLoginBtn');
        if(btn) {
          btn.addEventListener('click', function() {
            window.location.href = '/api/discord-login';
          });
        }
        // Rozcestn√≠k toggle skript
        var toggle = document.querySelector('.rozcestnik-toggle');
        var menu = document.querySelector('.rozcestnik-menu');
        if(toggle && menu) {
          toggle.addEventListener('click', function() {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
          });
          document.addEventListener('click', function(e) {
            if (!toggle.contains(e.target) && !menu.contains(e.target)) {
              menu.style.display = 'none';
            }
          });
        }
        // --- Doch√°zka embed toggle ---
        if(dochazkaBtn && dochazkaEmbed) {
          dochazkaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (dochazkaEmbed.style.display === 'block') {
              dochazkaEmbed.style.display = 'none';
            } else {
              dochazkaEmbed.style.display = 'block';
            }
          });
        }
        // --- Odesl√°n√≠ na Discord webhook ---
        async function sendDochazkaToDiscord(type) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) {
            if (actionStatusMessage) {
              actionStatusMessage.textContent = 'Nejste p≈ôihl√°≈°en p≈ôes Discord.';
              actionStatusMessage.style.color = '#e53935';
            }
            return;
          }
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390845026375831552/Wf4OvVgDoV44X-e-11SMn5yskwHHh2-DyEUohAzu853kn5TD-6_RNRrIl8LSuGVTUC1S';
          const now = new Date();
          const timeStr = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
          const statusText = type === 'in' ? 'P≈ôi≈°el do slu≈æby' : 'Ode≈°el ze slu≈æby';
          const color = type === 'in' ? 0x2ecc40 : 0xe53935;
          const embed = {
            color,
            title: 'Doch√°zka',
            description: `**${user.username}** ${statusText} v ${timeStr}.`,
            timestamp: now.toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          try {
            const resp = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            if (resp.ok) {
              if (actionStatusMessage) {
                actionStatusMessage.textContent = `Status √∫spƒõ≈°nƒõ zmƒõnƒõn: ${statusText}.`;
                actionStatusMessage.style.color = '#2ecc40';
              }
            } else {
              if (actionStatusMessage) {
                actionStatusMessage.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
                actionStatusMessage.style.color = '#e53935';
              }
            }
          } catch (e) {
            if (actionStatusMessage) {
              actionStatusMessage.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
              actionStatusMessage.style.color = '#e53935';
            }
          }
        }

        if (empInBtn) empInBtn.onclick = () => sendDochazkaToDiscord('in');
        if (empOutBtn) empOutBtn.onclick = () => sendDochazkaToDiscord('out');
      });
      // Glob√°ln√≠ p≈ôihl√°≈°en√≠ p≈ôes Discord (stejn√© jako na index.html)
      function isLoggedIn() {
        return localStorage.getItem('discordUser') !== null;
      }
      function showMainContent() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.body.style.overflow = '';
      }
      function showLogin() {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
      function saveDiscordUserFromUrl() {
        const params = new URLSearchParams(window.location.search);
        if(params.has('discordUser')) {
          try {
            const user = decodeURIComponent(params.get('discordUser'));
            localStorage.setItem('discordUser', user);
            window.history.replaceState({}, document.title, window.location.pathname);
            showMainContent();
          } catch(e) {}
        }
      }
      document.addEventListener('DOMContentLoaded', function() {
        saveDiscordUserFromUrl();
        var userBar = document.getElementById('userProfileBar');
        var loginBtn = document.getElementById('discordLoginBtn');
        var dochazkaBtn = document.getElementById('dochazkaBtn');
        var dochazkaEmbed = document.getElementById('dochazkaEmbed');
        var empInBtn = document.getElementById('empInBtn');
        var empOutBtn = document.getElementById('empOutBtn');
        var actionStatusMessage = document.getElementById('actionStatusMessage');
        if(isLoggedIn()) {
          showMainContent();
          // Zobrazit user bar
          if(userBar) {
            userBar.style.display = 'flex';
            const userStr = localStorage.getItem('discordUser');
            let user = null;
            try { user = JSON.parse(userStr); } catch(e) {}
            if(user) {
              let avatarUrl = user.avatar
                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';
              userBar.innerHTML = `
                <img src="${avatarUrl}" alt="avatar" style="width:38px;height:38px;border-radius:50%;box-shadow:0 2px 8px #0002;">
                <span>${user.username}#${user.discriminator}</span>
              `;
            }
          }
          // Skryt√≠ tlaƒç√≠tka P≈ôihl√°sit se
          if(loginBtn) loginBtn.style.display = 'none';
        } else {
          showLogin();
          if(userBar) userBar.style.display = 'none';
          if(loginBtn) loginBtn.style.display = 'inline-block';
        }
        var btn = document.getElementById('discordLoginBtn');
        if(btn) {
          btn.addEventListener('click', function() {
            window.location.href = '/api/discord-login';
          });
        }
        // Rozcestn√≠k toggle skript
        var toggle = document.querySelector('.rozcestnik-toggle');
        var menu = document.querySelector('.rozcestnik-menu');
        if(toggle && menu) {
          toggle.addEventListener('click', function() {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
          });
          document.addEventListener('click', function(e) {
            if (!toggle.contains(e.target) && !menu.contains(e.target)) {
              menu.style.display = 'none';
            }
          });
        }
        // --- Doch√°zka embed toggle ---
        if(dochazkaBtn && dochazkaEmbed) {
          dochazkaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (dochazkaEmbed.style.display === 'block') {
              dochazkaEmbed.style.display = 'none';
            } else {
              dochazkaEmbed.style.display = 'block';
            }
          });
        }
        // --- Odesl√°n√≠ na Discord webhook ---
        async function sendDochazkaToDiscord(type) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) {
            if (actionStatusMessage) {
              actionStatusMessage.textContent = 'Nejste p≈ôihl√°≈°en p≈ôes Discord.';
              actionStatusMessage.style.color = '#e53935';
            }
            return;
          }
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390845026375831552/Wf4OvVgDoV44X-e-11SMn5yskwHHh2-DyEUohAzu853kn5TD-6_RNRrIl8LSuGVTUC1S';
          const now = new Date();
          const timeStr = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
          const statusText = type === 'in' ? 'P≈ôi≈°el do slu≈æby' : 'Ode≈°el ze slu≈æby';
          const color = type === 'in' ? 0x2ecc40 : 0xe53935;
          const embed = {
            color,
            title: 'Doch√°zka',
            description: `**${user.username}** ${statusText} v ${timeStr}.`,
            timestamp: now.toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          try {
            const resp = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            if (resp.ok) {
              if (actionStatusMessage) {
                actionStatusMessage.textContent = `Status √∫spƒõ≈°nƒõ zmƒõnƒõn: ${statusText}.`;
                actionStatusMessage.style.color = '#2ecc40';
              }
            } else {
              if (actionStatusMessage) {
                actionStatusMessage.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
                actionStatusMessage.style.color = '#e53935';
              }
            }
          } catch (e) {
            if (actionStatusMessage) {
              actionStatusMessage.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
              actionStatusMessage.style.color = '#e53935';
            }
          }
        }
        // Doch√°zka embed toggle
        var dochazkaBtn = document.getElementById('dochazkaBtn');
        var dochazkaEmbed = document.getElementById('dochazkaEmbed');
        var dochazkaInBtn = document.getElementById('dochazkaInBtn');
        var dochazkaOutBtn = document.getElementById('dochazkaOutBtn');
        var dochazkaActionStatus = document.getElementById('dochazkaActionStatus');
        var closeDochazkaEmbed = document.getElementById('closeDochazkaEmbed');

        if (dochazkaBtn && dochazkaEmbed) {
          dochazkaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            dochazkaEmbed.style.display = 'block';
            dochazkaActionStatus.textContent = '';
          });
        }
        if (closeDochazkaEmbed) {
          closeDochazkaEmbed.onclick = () => { dochazkaEmbed.style.display = 'none'; };
        }
        // Zav≈ôi embed kliknut√≠m mimo nƒõj
        document.addEventListener('mousedown', function(e) {
          if (dochazkaEmbed.style.display === 'block' && !dochazkaEmbed.contains(e.target) && e.target !== dochazkaBtn) {
            dochazkaEmbed.style.display = 'none';
          }
        });

        async function sendDochazkaToDiscordEmbed(type) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) {
            if (dochazkaActionStatus) {
              dochazkaActionStatus.textContent = 'Nejste p≈ôihl√°≈°en p≈ôes Discord.';
              dochazkaActionStatus.style.color = '#e53935';
            }
            return;
          }
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390845026375831552/Wf4OvVgDoV44X-e-11SMn5yskwHHh2-DyEUohAzu853kn5TD-6_RNRrIl8LSuGVTUC1S';
          const now = new Date();
          const timeStr = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
          const statusText = type === 'in' ? 'P≈ôi≈°el do slu≈æby' : 'Ode≈°el ze slu≈æby';
          const color = type === 'in' ? 0x2ecc40 : 0xe53935;
          const embed = {
            color,
            title: 'Doch√°zka',
            description: `**${user.username}** ${statusText} v ${timeStr}.`,
            timestamp: now.toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          try {
            const resp = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            if (resp.ok) {
              dochazkaActionStatus.textContent = `Status √∫spƒõ≈°nƒõ zmƒõnƒõn: ${statusText}.`;
              dochazkaActionStatus.style.color = '#2ecc40';
            } else {
              dochazkaActionStatus.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
              dochazkaActionStatus.style.color = '#e53935';
            }
          } catch (e) {
            dochazkaActionStatus.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
            dochazkaActionStatus.style.color = '#e53935';
          }
        }

        if (dochazkaInBtn) dochazkaInBtn.onclick = () => sendDochazkaToDiscordEmbed('in');
        if (dochazkaOutBtn) dochazkaOutBtn.onclick = () => sendDochazkaToDiscordEmbed('out');
      });
      document.addEventListener('DOMContentLoaded', function() {
        const sluzbaBtn = document.getElementById('sluzbaBtn');
        const sluzbaWidget = document.getElementById('sluzbaWidget');
        const empInBtn = document.getElementById('empInBtn');
        const empOutBtn = document.getElementById('empOutBtn');
        const actionStatusMessage = document.getElementById('actionStatusMessage');

        if (sluzbaBtn && sluzbaWidget) {
          sluzbaBtn.onclick = () => {
            sluzbaWidget.style.display = sluzbaWidget.style.display === 'none' ? 'block' : 'none';
          };
          // Kliknut√≠ mimo widget ho zav≈ôe
          document.addEventListener('click', function(e) {
            if (sluzbaWidget.style.display === 'block' && !sluzbaWidget.contains(e.target) && e.target !== sluzbaBtn) {
              sluzbaWidget.style.display = 'none';
            }
          });
        }

        async function sendDochazkaToDiscord(type) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) {
            if (actionStatusMessage) {
              actionStatusMessage.textContent = 'Nejste p≈ôihl√°≈°en p≈ôes Discord.';
              actionStatusMessage.style.color = '#e53935';
            }
            return;
          }
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390845026375831552/Wf4OvVgDoV44X-e-11SMn5yskwHHh2-DyEUohAzu853kn5TD-6_RNRrIl8LSuGVTUC1S';
          const now = new Date();
          const timeStr = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
          const statusText = type === 'in' ? 'P≈ôi≈°el do slu≈æby' : 'Ode≈°el ze slu≈æby';
          const color = type === 'in' ? 0x2ecc40 : 0xe53935;
          const embed = {
            color,
            title: 'Doch√°zka',
            description: `**${user.username}** ${statusText} v ${timeStr}.`,
            timestamp: now.toISOString(),
            footer: { text: 'Multi-Cargo Doprava' }
          };
          try {
            const resp = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ embeds: [embed] })
            });
            if (resp.ok) {
              if (actionStatusMessage) {
                actionStatusMessage.textContent = `Status √∫spƒõ≈°nƒõ zmƒõnƒõn: ${statusText}.`;
                actionStatusMessage.style.color = '#2ecc40';
              }
            } else {
              if (actionStatusMessage) {
                actionStatusMessage.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
                actionStatusMessage.style.color = '#e53935';
              }
            }
          } catch (e) {
            if (actionStatusMessage) {
              actionStatusMessage.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ na Discord.';
              actionStatusMessage.style.color = '#e53935';
            }
          }
        }

        if (empInBtn) empInBtn.onclick = () => sendDochazkaToDiscord('in');
        if (empOutBtn) empOutBtn.onclick = () => sendDochazkaToDiscord('out');
      });
      document.addEventListener('DOMContentLoaded', function() {
        const pracovatBtn = document.getElementById('pracovatBtn');
        const trainWidgetOverlay = document.getElementById('trainWidgetOverlay');
        const trainWidget = document.getElementById('trainWidget');
        const trainListModern = document.getElementById('trainListModern');
        const closeTrainWidget = document.getElementById('closeTrainWidget');
        const trainDetailWidgetOverlay = document.getElementById('trainDetailWidgetOverlay');
        const trainDetailWidget = document.getElementById('trainDetailWidget');
        const trainDetailContent = document.getElementById('trainDetailContent');
        const endRideBtn = document.getElementById('endRideBtn');
        const closeTrainDetailWidget = document.getElementById('closeTrainDetailWidget');
        let selectedTrain = null;
        let updateInterval = null;

        if (pracovatBtn) {
          pracovatBtn.onclick = async function() {
            trainWidgetOverlay.style.display = 'flex';
            trainListModern.innerHTML = '<div style="color:#0057b8;">Naƒç√≠t√°m vlaky...</div>';
            closeTrainWidget.style.display = 'block';
            // Naƒçti vlaky z API
            try {
              const res = await fetch('https://panel.simrail.eu:8084/trains-open?serverCode=int1');
              const data = await res.json();
              // Se≈ôaƒè podle nejbli≈æ≈°√≠ho odjezdu a vezmi prvn√≠ 4
              const now = Date.now();
              const sorted = data
                .filter(t => t.departureTimestamp * 1000 > now)
                .sort((a, b) => a.departureTimestamp - b.departureTimestamp)
                .slice(0, 4);
              trainListModern.innerHTML = '';
              sorted.forEach(train => {
                const div = document.createElement('div');
                div.style = 'background:#f7f8fa;border-radius:18px;padding:22px 18px;margin-bottom:10px;box-shadow:0 2px 8px #0057b822;display:flex;flex-direction:column;align-items:center;min-width:200px;max-width:220px;border:2px solid #0057b8;';
                div.innerHTML = `
                  <div style="font-size:2.5em;color:#ff5733;margin-bottom:8px;">üöÜ</div>
                  <div style="font-size:1.5em;font-weight:600;color:#ff5733;margin-bottom:6px;">${train.trainNo}</div>
                  <div style="font-size:1.1em;color:#ff5733;margin-bottom:10px;">${train.fromName} ‚Üí ${train.toName}</div>
                  <button class="takeTrainModernBtn" style="margin-top:10px;padding:10px 22px;border-radius:8px;border:2px solid #ff5733;background:#fff;color:#ff5733;font-weight:600;font-size:1.08em;cursor:pointer;">TLAƒå√çTKO P≈òEVZ√çT</button>
                `;
                div.querySelector('.takeTrainModernBtn').onclick = () => selectTrainModern(train);
                trainListModern.appendChild(div);
              });
            } catch (e) {
              trainListModern.innerHTML = '<div style="color:#e53935;">Chyba p≈ôi naƒç√≠t√°n√≠ vlak≈Ø.</div>';
            }
          };
        }

        if (closeTrainWidget) {
          closeTrainWidget.onclick = () => {
            trainWidgetOverlay.style.display = 'none';
          };
        }

        async function selectTrainModern(train) {
          selectedTrain = train;
          trainWidgetOverlay.style.display = 'none';
          trainDetailWidgetOverlay.style.display = 'flex';
          closeTrainDetailWidget.style.display = 'none';
          renderTrainDetail(train);
          // Odeslat na Discord p≈ôevzet√≠
          sendTrainDiscord('take', train);
          // Aktualizace ƒças≈Ø ka≈æd√Ωch 10s
          if (updateInterval) clearInterval(updateInterval);
          updateInterval = setInterval(() => renderTrainDetail(selectedTrain), 10000);
        }

        function renderTrainDetail(train) {
          const now = Date.now();
          const arrival = new Date(train.arrivalTimestamp * 1000);
          const departure = new Date(train.departureTimestamp * 1000);
          trainDetailContent.innerHTML = `
            <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
              <div style="font-size:3em;color:#ff5733;">üöÜ</div>
              <div>
                <div style="font-size:2.2em;font-weight:600;color:#ff5733;">V√°≈° Vlak</div>
                <div style="font-size:1.3em;color:#ff5733;">${train.trainNo}</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;gap:32px;margin-bottom:18px;">
              <div style="font-size:1.5em;color:#ff5733;">${train.fromName}</div>
              <div style="font-size:2em;">‚Üí</div>
              <div style="font-size:1.5em;color:#ff5733;">${train.toName}</div>
            </div>
            <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:18px;">
              <div style="color:#ff5733;">ƒåAS P≈ò√çJEZDU<br><b>${arrival.toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit'})}</b></div>
              <div style="color:#ff5733;">P≈ò√ç≈†T√ç ZAST√ÅVKA<br><b>${train.nextStationName || '-'}</b></div>
              <div style="color:#ff5733;">ƒåAS ODJEZDU<br><b>${departure.toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit'})}</b></div>
            </div>
            <button id="currentTimeBtn" style="position:absolute;top:32px;right:32px;padding:10px 28px;border-radius:8px;border:2px solid #ff5733;background:#fff;color:#ff5733;font-weight:600;font-size:1.08em;cursor:pointer;">AKTU√ÅLN√ç ƒåAS</button>
          `;
          // K≈ô√≠≈æek se zobraz√≠ a≈æ po ukonƒçen√≠ j√≠zdy
          closeTrainDetailWidget.style.display = 'none';
          document.getElementById('currentTimeBtn').onclick = () => {
            alert('Aktu√°ln√≠ ƒças serveru: ' + new Date().toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit',second:'2-digit'}));
          };
        }

        if (endRideBtn) {
          endRideBtn.onclick = () => {
            // Odeslat na Discord ukonƒçen√≠
            sendTrainDiscord('end', selectedTrain);
            trainDetailWidgetOverlay.style.display = 'none';
            if (updateInterval) clearInterval(updateInterval);
            closeTrainDetailWidget.style.display = 'block';
          };
        }

        // K≈ô√≠≈æek se objev√≠ a≈æ po ukonƒçen√≠ j√≠zdy
        if (closeTrainDetailWidget) {
          closeTrainDetailWidget.onclick = () => {
            trainDetailWidgetOverlay.style.display = 'none';
            if (updateInterval) clearInterval(updateInterval);
          };
        }

        async function sendTrainDiscord(action, train) {
          const userStr = localStorage.getItem('discordUser');
          if (!userStr) return;
          let user;
          try { user = JSON.parse(userStr); } catch (e) { return; }
          const webhookUrl = 'https://discord.com/api/webhooks/1390989690072727605/IwgaE5140eg1RVJuIgC8hmjGpi-IhC5pYCAzRJqstgtFVkuzQ8YadyR4TWhXC9UysbMv';
          let embed;
          if (action === 'take') {
            embed = {
              color: 0x0057b8,
              title: 'üöÜ P≈ôevzet√≠ vlaku',
              description: `**${user.username}** si pr√°vƒõ p≈ôevzal vlak **${train.trainNo}** z **${train.fromName}** do **${train.toName}**.`,
              timestamp: new Date().toISOString(),
              footer: { text: 'Multi-Cargo Doprava' }
            };
          } else {
            embed = {
              color: 0xe53935,
              title: 'üõë Ukonƒçen√≠ j√≠zdy',
              description: `**${user.username}** pr√°vƒõ ukonƒçil j√≠zdu vlaku **${train.trainNo}** z **${train.fromName}** do **${train.toName}**.`,
              timestamp: new Date().toISOString(),
              footer: { text: 'Multi-Cargo Doprava' }
            };
          }
          await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds: [embed] })
          });
        }
      });
    </script>
    <footer class="footer">
        &copy; 2025 Multi-Cargo Doprava (MCD) &mdash; str√°nka strojvedouc√≠ch
    </footer>

    <!-- Modal pro v√Ωbƒõr serveru a vlaku (p≈ôesunuto na konec body) -->
    <div id="workModalOverlay" style="display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="workModal" style="background:#fff;padding:32px 28px 24px 28px;border-radius:18px;box-shadow:0 8px 32px #0008;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;display:flex;flex-direction:column;align-items:center;">
        <h2 style="margin-top:0;margin-bottom:18px;font-size:1.35em;">V√Ωbƒõr serveru</h2>
        <div id="serverList" style="display:flex;flex-wrap:wrap;gap:12px 18px;margin-bottom:24px;justify-content:center;align-items:center;min-height:60px;font-size:1.13em;color:#0057b8;font-weight:600;">
          Na √∫pravƒõ se aktu√°lnƒõ pracuje.
        </div>
        <div id="trainListSection" style="display:none;width:100%;">
          <h3 style="margin-bottom:12px;font-size:1.13em;">V√Ωbƒõr vlaku</h3>
          <div id="trainList" style="max-height:320px;overflow-y:auto;"></div>
        </div>
        <div id="selectedTrainSection" style="display:none;margin-top:18px;text-align:center;width:100%;">
          <div id="selectedTrainInfo" style="margin-bottom:14px;"></div>
          <button id="takeTrainBtn" class="discord-login-btn" style="margin-right:12px;">üöÜ P≈ôevz√≠t</button>
          <button id="endTrainBtn" class="duty-red">üõë Ukonƒçit j√≠zdu</button>
        </div>
        <button id="closeWorkModal" style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:1.5em;cursor:pointer;">&times;</button>
      </div>
    </div>

    <!-- Tlaƒç√≠tko "Slu≈æba" (m≈Ø≈æe≈° ho um√≠stit do rozcestn√≠ku nebo kam pot≈ôebuje≈°) -->
    <button id="sluzbaBtn" class="rozcestnik-tile" style="margin-top:18px;">üïí Slu≈æba</button>

    <!-- Mal√Ω widget pro p≈ô√≠chod/odchod, zobrazuje se a≈æ po kliknut√≠ na tlaƒç√≠tko "Slu≈æba" -->
    <div id="sluzbaWidget" style="display:none; position:fixed; top:90px; right:40px; background:#fff; border-radius:12px; box-shadow:0 4px 24px #0057b822; padding:22px 18px; z-index:2000; min-width:180px;">
      <div style="font-weight:600; margin-bottom:10px; text-align:center;">Doch√°zka</div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="empInBtn" style="padding:7px 16px; border-radius:7px; border:none; background:#2ecc40; color:#fff; font-weight:600; cursor:pointer;">P≈ô√≠chod</button>
        <button id="empOutBtn" style="padding:7px 16px; border-radius:7px; border:none; background:#e53935; color:#fff; font-weight:600; cursor:pointer;">Odchod</button>
      </div>
      <div id="actionStatusMessage" style="min-height:18px; margin-top:10px; font-size:0.97em; text-align:center;"></div>
    </div>

    <!-- ODSTRA≈áTE tento ≈ô√°dek, pokud u≈æ existuje nƒõkde v HTML -->
    <!-- <div id="dochazkaEmbed" ...> ... </div> -->

    <!-- P≈òIDEJTE TENTO BLOK tƒõsnƒõ p≈ôed </body> (nebo na konec hlavn√≠ho panelu, ale mimo modal a widget slu≈æby) -->
    <div id="dochazkaEmbed" style="display:none; position:fixed; top:110px; left:50%; transform:translateX(-50%); background:#fff; border-radius:14px; box-shadow:0 4px 24px #0057b822; padding:28px 18px 22px 18px; z-index:3000; min-width:220px; max-width:96vw;">
      <div style="font-size:1.18em; font-weight:600; margin-bottom:14px; text-align:center;">Moje doch√°zka</div>
      <div id="dochazkaActionStatus" style="min-height:22px; margin-bottom:10px; color:#0057b8; text-align:center;"></div>
      <div style="display:flex; gap:18px; justify-content:center;">
        <button id="dochazkaInBtn" style="padding:10px 22px; font-size:1.08em; border-radius:8px; border:none; background:#2ecc40; color:#fff; font-weight:600; cursor:pointer;">P≈ô√≠chod</button>
        <button id="dochazkaOutBtn" style="padding:10px 22px; font-size:1.08em; border-radius:8px; border:none; background:#e53935; color:#fff; font-weight:600; cursor:pointer;">Odchod</button>
      </div>
      <button id="closeDochazkaEmbed" style="position:absolute;top:10px;right:16px;background:none;border:none;font-size:1.3em;cursor:pointer;">&times;</button>
    </div>

    <!-- Widget pro v√Ωbƒõr vlaku -->
    <div id="trainWidgetOverlay" style="display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;">
        <h2 style="margin-top:0;margin-bottom:18px;font-size:2em;color:#0057b8;">V√Ωbƒõr vlaku</h2>
        <div id="trainListModern" style="display:flex;gap:32px;justify-content:center;flex-wrap:wrap;width:100%;"></div>
        <button id="closeTrainWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div>

    <!-- Widget pro detail vlaku -->
    <div id="trainDetailWidgetOverlay" style="display:none;position:fixed;z-index:10001;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainDetailWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;position:relative;">
        <div id="trainDetailContent"></div>
        <button id="endRideBtn" style="margin-top:32px;padding:12px 32px;border-radius:10px;border:2px solid #e53935;background:#fff;color:#e53935;font-weight:600;font-size:1.1em;cursor:pointer;">TLAƒå√çTKO UKONƒåIT J√çZDU</button>
        <button id="closeTrainDetailWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div>
</body>
</html>
