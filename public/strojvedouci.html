<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strojvedoucí | Multi-Cargo Doprava</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', Arial, sans-serif; background: #f7f8fa; color: #23272a; }
      #loginOverlay { position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.97);display:flex;align-items:center;justify-content:center;flex-direction:column; }
      #loginOverlay > div { background:#23272a;padding:36px 32px 28px 32px;border-radius:18px;box-shadow:0 8px 32px #0008;display:flex;flex-direction:column;align-items:center;min-width:320px; }
      #loginOverlay img { width:72px;height:72px;border-radius:16px;margin-bottom:18px;box-shadow:0 2px 8px #0006; }
      .discord-login-btn { background: linear-gradient(90deg, #6a8cff 0%, #a084ee 100%); color: #fff; border: none; border-radius: 9px; font-weight: 600; font-size: 1.15em; padding: 12px 32px; box-shadow: 0 2px 8px #6a8cff22; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; }
      .discord-login-btn:hover { background: linear-gradient(90deg, #4f6edb 0%, #a084ee 100%); box-shadow: 0 4px 16px #6a8cff33; }
      #userProfileBar { display: flex; align-items: center; justify-content: flex-end; padding: 8px 16px; background: #fff; border-bottom: 1px solid #eaeaea; }
      #userProfileBar img { width: 38px; height: 38px; border-radius: 50%; margin-right: 8px; }
      #userProfileBar span { font-size: 0.9rem; color: #23272a; }
    </style>
</head>
<body>
    <div id="loginOverlay" style="display:none;">
      <div>
        <img src="/logo.webp" alt="Logo">
        <h2 style="color:#fff;font-size:1.5em;margin-bottom:10px;">Přihlášení do MCD</h2>
        <p style="color:#b9bbbe;font-size:1.08em;margin-bottom:22px;text-align:center;">Pro pokračování se přihlašte přes Discord.</p>
        <button id="discordLoginBtn" class="discord-login-btn" style="font-size:1.15em;padding:12px 32px;border-radius:9px;box-shadow:0 2px 8px #0004;">🔑 Přihlásit se přes Discord</button>
      </div>
    </div>
    <div id="userProfileBar" style="display:none;"></div>
    <header class="header-logo-title">
        <h1>Strojvedoucí <span class="mcd-accent">MCD</span></h1>
        <div class="subtitle">Přehled a správa strojvedoucích společnosti</div>
    </header>
    <div class="animated-bar"></div>
    <div class="main-rozcestnik">
      <div class="rozcestnik-palette">
        <button class="rozcestnik-toggle">☰ Otevřít rozcestník</button>
        <div class="rozcestnik-menu" style="display:none;">
          <a href="/strojvedouci.html" class="rozcestnik-link active">👤 Strojvedoucí</a>
          <a href="/index.html" class="rozcestnik-link">🏠 Dispečink</a>
        </div>
      </div>
      <div class="rozcestnik-welcome">
        <h2>Strojvedoucí</h2>
        <p>Vyberte si akci:</p>
        <ul class="rozcestnik-list">
          <li>
            <button class="rozcestnik-tile" id="sluzbaBtn" style="margin-bottom:12px;">🕒 Příchod do služby</button>
          </li>
          <li>
            <a href="#zamestnanci" class="rozcestnik-tile" onclick="document.getElementById('zamestnanciSection').scrollIntoView({behavior:'smooth'});return false;">👤 Zaměstnanci</a>
          </li>
          <li>
            <button class="rozcestnik-tile" id="pracovatBtn" style="margin: 24px auto 0 auto; display: block;">💼 Pracovat</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Widget pro výběr vlaku -->
    <div id="trainWidgetOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,34,40,0.92); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:22px; box-shadow:0 8px 32px #0057b822; padding:32px 28px; min-width:320px; max-width:98vw; max-height:90vh; overflow:auto;">
        <button id="closeTrainWidget" style="position:absolute;top:14px;right:22px;background:none;border:none;font-size:2em;cursor:pointer;color:#0057b8;">&times;</button>
        <div id="trainListModern"></div>
      </div>
    </div>

    <!-- Widget pro detail vlaku -->
    <div id="trainDetailWidgetOverlay" style="display:none;position:fixed;z-index:10001;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
      <div id="trainDetailWidget" style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #0057b8cc;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;align-items:center;border:4px solid #0057b8;position:relative;">
        <div id="trainDetailContent"></div>
        <button id="endRideBtn" style="margin-top:32px;padding:12px 32px;border-radius:10px;border:2px solid #e53935;background:#fff;color:#e53935;font-weight:600;font-size:1.1em;cursor:pointer;">TLAČÍTKO UKONČIT JÍZDU</button>
        <button id="closeTrainDetailWidget" style="display:none;position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#0057b8;">&times;</button>
      </div>
    </div>
<!-- Widget pro zaměstnance -->
<div id="zamestnanciWidgetOverlay" style="display:none;position:fixed;z-index:3000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);align-items:center;justify-content:center;">
  <div id="zamestnanciWidget" style="background:linear-gradient(120deg,#fffbe6 0%,#ffe9b3 100%);border-radius:28px;box-shadow:0 8px 32px #bfa13a88;padding:38px 32px 32px 32px;min-width:340px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;">
    <button id="closeZamestnanciWidget" style="position:absolute;top:18px;right:28px;background:none;border:none;font-size:2.2em;cursor:pointer;color:#bfa13a;">&times;</button>
    <h2 style="color:#bfa13a;text-align:center;margin-bottom:18px;">Zaměstnanci</h2>
    <div id="zamestnanciAktualne" style="margin-bottom:28px;">
      <h3 style="color:#bfa13a;">Aktuálně v práci</h3>
      <div id="zamestnanciAktualneList">Načítám...</div>
    </div>
    <div id="zamestnanciSkore">
      <h3 style="color:#bfa13a;">Skóre</h3>
      <div id="zamestnanciSkoreList">Načítám...</div>
    </div>
  </div>
</div>
    <section id="zamestnanciSection" style="margin: 40px auto; max-width: 600px; display: none;">
      <h2>Zaměstnanci online</h2>
      <div id="zamestnanciList">Načítám...</div>
    </section>

    <script type="module">
import { supabase } from '/lib/supabaseClient.js';

const zamestnanciBtn = document.querySelector('a[href="#zamestnanci"]');
const zamestnanciWidgetOverlay = document.getElementById('zamestnanciWidgetOverlay');
const zamestnanciWidget = document.getElementById('zamestnanciWidget');
const closeZamestnanciWidget = document.getElementById('closeZamestnanciWidget');
const zamestnanciAktualneList = document.getElementById('zamestnanciAktualneList');
const zamestnanciSkoreList = document.getElementById('zamestnanciSkoreList');

if (zamestnanciBtn && zamestnanciWidgetOverlay && zamestnanciAktualneList && zamestnanciSkoreList) {
  zamestnanciBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    zamestnanciWidgetOverlay.style.display = 'flex';

    // 1. Načti aktuálně přihlášené zaměstnance a jejich vlaky
    zamestnanciAktualneList.textContent = 'Načítám...';
    let { data: online, error: err1 } = await supabase
      .from('users_online')
      .select('*')
      .eq('online', true);
    if (err1 || !online) online = [];

    // 2. Načti skóre zaměstnanců
    zamestnanciSkoreList.textContent = 'Načítám...';
    let { data: score, error: err2 } = await supabase
      .from('users_score')
      .select('*');
    if (err2 || !score) score = [];

    // Výpis aktuálně v práci
    if (online.length === 0) {
      zamestnanciAktualneList.innerHTML = '<i>Nikdo není aktuálně ve službě.</i>';
    } else {
      zamestnanciAktualneList.innerHTML = `
        <table style="width:100%;border-collapse:collapse;">
          <tr style="background:#fffbe6;">
            <th style="padding:6px 8px;border-bottom:1px solid #bfa13a;">Jméno</th>
            <th style="padding:6px 8px;border-bottom:1px solid #bfa13a;">Vlak</th>
            <th style="padding:6px 8px;border-bottom:1px solid #bfa13a;">Trasa</th>
          </tr>
          ${online.map(u => `
            <tr>
              <td style="padding:6px 8px;">${u.username}</td>
              <td style="padding:6px 8px;">${u.train_no || '-'}</td>
              <td style="padding:6px 8px;">${u.train_from || '-'} → ${u.train_to || '-'}</td>
            </tr>
          `).join('')}
        </table>
      `;
    }

    // Výpis skóre
    if (score.length === 0) {
      zamestnanciSkoreList.innerHTML = '<i>Žádná data o jízdách.</i>';
    } else {
      zamestnanciSkoreList.innerHTML = `
        <table style="width:100%;border-collapse:collapse;">
          <tr style="background:#fffbe6;">
            <th style="padding:6px 8px;border-bottom:1px solid #bfa13a;">Jméno</th>
            <th style="padding:6px 8px;border-bottom:1px solid #bfa13a;">Počet jízd</th>
            <th style="padding:6px 8px;border-bottom:1px solid #bfa13a;">Čas ve službě</th>
          </tr>
          ${score.map(u => `
            <tr>
              <td style="padding:6px 8px;">${u.username}</td>
              <td style="padding:6px 8px;">${u.rides_count || 0}</td>
              <td style="padding:6px 8px;">${u.time_online || '0 min'}</td>
            </tr>
          `).join('')}
        </table>
      `;
    }
  });

  // Zavření widgetu
  if (closeZamestnanciWidget) {
    closeZamestnanciWidget.onclick = () => zamestnanciWidgetOverlay.style.display = 'none';
  }
}

    document.addEventListener('DOMContentLoaded', function() {
      // Přihlášení přes Discord a zobrazení uživatele
      function isLoggedIn() {
        return localStorage.getItem('discordUser') !== null;
      }
      function showMainContent() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.body.style.overflow = '';
      }
      function showLogin() {
        document.getElementById('loginOverlay').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
      function saveDiscordUserFromUrl() {
        const params = new URLSearchParams(window.location.search);
        if(params.has('discordUser')) {
          try {
            const user = decodeURIComponent(params.get('discordUser'));
            localStorage.setItem('discordUser', user);
            window.history.replaceState({}, document.title, window.location.pathname);
            showMainContent();
          } catch(e) {}
        }
      }
      saveDiscordUserFromUrl();
      var userBar = document.getElementById('userProfileBar');
      var loginBtn = document.getElementById('discordLoginBtn');
      if(isLoggedIn()) {
        showMainContent();
        if(userBar) {
          userBar.style.display = 'flex';
          const userStr = localStorage.getItem('discordUser');
          let user = null;
          try { user = JSON.parse(userStr); } catch(e) {}
          if(user) {
            let avatarUrl = user.avatar
              ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
              : 'https://cdn.discordapp.com/embed/avatars/0.png';
            userBar.innerHTML = `
              <img src="${avatarUrl}" alt="avatar" style="width:38px;height:38px;border-radius:50%;box-shadow:0 2px 8px #0002;">
              <span>${user.username}#${user.discriminator}</span>
            `;
          }
        }
        if(loginBtn) loginBtn.style.display = 'none';
      } else {
        showLogin();
        if(userBar) userBar.style.display = 'none';
        if(loginBtn) loginBtn.style.display = 'inline-block';
      }
      var btn = document.getElementById('discordLoginBtn');
      if(btn) {
        btn.addEventListener('click', function() {
          window.location.href = '/api/discord-login';
        });
      }

      // Rozcestník toggle
      var toggle = document.querySelector('.rozcestnik-toggle');
      var menu = document.querySelector('.rozcestnik-menu');
      if(toggle && menu) {
        toggle.addEventListener('click', function() {
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', function(e) {
          if (!toggle.contains(e.target) && !menu.contains(e.target)) {
            menu.style.display = 'none';
          }
        });
      }

      // --- MODERNÍ WIDGET PRO VÝBĚR VLAKU ---
      const pracovatBtn = document.getElementById('pracovatBtn');
      const trainWidgetOverlay = document.getElementById('trainWidgetOverlay');
      const trainListModern = document.getElementById('trainListModern');
      const closeTrainWidget = document.getElementById('closeTrainWidget');
      const trainDetailWidgetOverlay = document.getElementById('trainDetailWidgetOverlay');
      const trainDetailWidget = document.getElementById('trainDetailWidget');
      const trainDetailContent = document.getElementById('trainDetailContent');
      const endRideBtn = document.getElementById('endRideBtn');
      const closeTrainDetailWidget = document.getElementById('closeTrainDetailWidget');
      let selectedTrain = null;
      let updateInterval = null;

      // MODAL pro výběr serveru
      function showServerSelectModal(onSelect) {
        let old = document.getElementById('serverSelectModal');
        if (old) old.remove();
        const modal = document.createElement('div');
        modal.id = 'serverSelectModal';
        modal.style = 'position:fixed;z-index:10020;top:0;left:0;width:100vw;height:100vh;background:rgba(30,34,40,0.92);display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:22px;box-shadow:0 8px 32px #bfa13a88;min-width:320px;max-width:98vw;max-height:90vh;overflow-y:auto;position:relative;">
            <h2 style="margin-top:0;margin-bottom:18px;font-size:1.35em;color:#0057b8;text-align:center;">Vyber server</h2>
            <div style="display:flex;gap:18px;justify-content:center;">
              <button class="serverBtn" data-server="INT1" style="padding:12px 28px;font-size:1.13em;border-radius:10px;border:2px solid #0057b8;background:#f7f8fa;color:#0057b8;font-weight:600;cursor:pointer;">INT1</button>
              <button class="serverBtn" data-server="CZ1" style="padding:12px 28px;font-size:1.13em;border-radius:10px;border:2px solid #bfa13a;background:#f7f8fa;color:#bfa13a;font-weight:600;cursor:pointer;">CZ1</button>
            </div>
            <button id="closeServerSelectModal" style="position:absolute;top:14px;right:22px;background:none;border:none;font-size:2em;cursor:pointer;color:#0057b8;">&times;</button>
          </div>
        `;
        document.body.appendChild(modal);
        modal.querySelectorAll('.serverBtn').forEach(btn => {
          btn.onclick = () => {
            const server = btn.getAttribute('data-server');
            modal.remove();
            onSelect(server);
          };
        });
        document.getElementById('closeServerSelectModal').onclick = () => modal.remove();
      }

      if (pracovatBtn && trainWidgetOverlay && trainListModern && closeTrainWidget) {
        pracovatBtn.addEventListener('click', function() {
          showServerSelectModal(async function(server) {
            trainWidgetOverlay.style.display = 'flex';
            trainListModern.innerHTML = '<div style="color:#0057b8;">Načítám vlaky...</div>';
            let apiServerCode = server.toLowerCase();
            let trainsApi = `https://panel.simrail.eu:8084/trains-open?serverCode=${apiServerCode}`;
            try {
              const res = await fetch(trainsApi);
              let data = await res.json();
              if (!Array.isArray(data)) {
                if (Array.isArray(data.trains)) data = data.trains;
                else if (Array.isArray(data.data)) data = data.data;
                else throw new Error('Neplatný formát dat z API');
              }
              const sorted = data
                .filter(t => (t.TrainData?.VDDelayedTimetableIndex !== undefined))
                .sort((a, b) => (a.TrainData.VDDelayedTimetableIndex ?? 9999) - (b.TrainData.VDDelayedTimetableIndex ?? 9999))
                .slice(0, 30); // Zobrazí až 30 vlaků místo 4!
              trainListModern.innerHTML = '';
              sorted.forEach(train => {
                const div = document.createElement('div');
                div.style = 'background:#f7f8fa;border-radius:18px;padding:22px 18px;margin-bottom:10px;box-shadow:0 2px 8px #0057b822;display:flex;flex-direction:column;align-items:center;min-width:200px;max-width:220px;border:2px solid #0057b8;';
                div.innerHTML = `
                  <div style="font-size:2.5em;color:#ff5733;margin-bottom:8px;">🚆</div>
                  <div style="font-size:1.5em;font-weight:600;color:#ff5733;margin-bottom:6px;">${train.TrainNoLocal}</div>
                  <div style="font-size:1.1em;color:#ff5733;margin-bottom:10px;">${train.StartStation} → ${train.EndStation}</div>
                  <button class="takeTrainModernBtn" style="margin-top:10px;padding:10px 22px;border-radius:8px;border:2px solid #ff5733;background:#fff;color:#ff5733;font-weight:600;font-size:1.08em;cursor:pointer;">TLAČÍTKO PŘEVZÍT</button>
                `;
                div.querySelector('.takeTrainModernBtn').onclick = () => selectTrainModern(train);
                trainListModern.appendChild(div);
              });
              if (sorted.length === 0) {
                trainListModern.innerHTML = '<div style="color:#e53935;">Žádné vlaky k dispozici.</div>';
              }
            } catch (e) {
              trainListModern.innerHTML = '<div style="color:#e53935;">Chyba při načítání vlaků.<br>' + e + '</div>';
            }
          });
        });
        closeTrainWidget.addEventListener('click', function() {
          trainWidgetOverlay.style.display = 'none';
        });
      }

      // Funkce pro převzetí vlaku (zobrazí detail a pošle webhook)
      async function selectTrainModern(train) {
        selectedTrain = train;
        trainWidgetOverlay.style.display = 'none';
        trainDetailWidgetOverlay.style.display = 'flex';
        closeTrainDetailWidget.style.display = 'block';
        renderTrainDetail(train);

        // Odeslání na Discord webhook při převzetí vlaku
        let user = null;
        try {
          user = JSON.parse(localStorage.getItem('discordUser'));
        } catch (e) {}
        const username = user ? `${user.username}#${user.discriminator}` : 'Neznámý uživatel';
        const webhookUrl = 'https://discord.com/api/webhooks/1390989690072727605/IwgaE5140eg1RVJuIgC8hmjGpi-IhC5pYCAzRJqstgtFVkuzQ8YadyR4TWhXC9UysbMv';
        const payload = {
          embeds: [{
            title: `🚆 Převzetí vlaku`,
            description: `Uživatel **${username}** právě převzal vlak **${train.TrainNoLocal}** (${train.StartStation} → ${train.EndStation})`,
            color: 3447003, // modrá
            timestamp: new Date().toISOString()
          }]
        };
        try {
          await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          console.error('Nepodařilo se odeslat na Discord webhook:', e);
        }

        // Zápis do Supabase - aktualizace vlaku u uživatele
        if (user) {
          await supabase.from('users_online').update({
            train_no: train.TrainNoLocal,
            train_from: train.StartStation,
            train_to: train.EndStation
          }).eq('username', user.username);
        }
      }

      // Zobraz detail vlaku
      function renderTrainDetail(train) {
        trainDetailContent.innerHTML = `
          <div style="display:flex;align-items:center;gap:18px;margin-bottom:18px;">
            <div style="font-size:3em;color:#ff5733;">🚆</div>
            <div>
              <div style="font-size:2.2em;font-weight:600;color:#ff5733;">Váš Vlak</div>
              <div style="font-size:1.3em;color:#ff5733;">${train.TrainNoLocal}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;justify-content:center;gap:32px;margin-bottom:18px;">
            <div style="font-size:1.5em;color:#ff5733;">${train.StartStation}</div>
            <div style="font-size:2em;">→</div>
            <div style="font-size:1.5em;color:#ff5733;">${train.EndStation}</div>
          </div>
          <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:18px;">
            <div style="color:#ff5733;">VOZIDLA<br><b>${(train.Vehicles || []).join(', ')}</b></div>
            <div style="color:#ff5733;">TYP<br><b>${train.TrainName || '-'}</b></div>
            <div style="color:#ff5733;">SERVER<br><b>${train.ServerCode || '-'}</b></div>
          </div>
        `;
        // Zavření detailu
        if (closeTrainDetailWidget) {
          closeTrainDetailWidget.onclick = () => {
            trainDetailWidgetOverlay.style.display = 'none';
            closeTrainDetailWidget.style.display = 'none';
          };
        }
        // Ukončení jízdy
        if (endRideBtn) {
          endRideBtn.onclick = async () => {
            trainDetailWidgetOverlay.style.display = 'none';
            closeTrainDetailWidget.style.display = 'none';

            // Zápis do Supabase - zvýšení počtu jízd
            let user = null;
            try {
              user = JSON.parse(localStorage.getItem('discordUser'));
            } catch (e) {}
            if (user) {
              // Získání aktuálního počtu jízd
              const { data } = await supabase.from('users_score').select('rides_count').eq('username', user.username).single();
              const newCount = (data?.rides_count || 0) + 1;
              await supabase.from('users_score').upsert({
                username: user.username,
                rides_count: newCount
              });
            }
          };
        }
      }

      // Funkce pro službu s webhookem
      const sluzbaBtn = document.getElementById('sluzbaBtn');
      let veSluzbe = false;

      // Na začátku zakázat tlačítko Pracovat
      if (pracovatBtn) pracovatBtn.disabled = true;

      if (sluzbaBtn) {
        sluzbaBtn.addEventListener('click', async function() {
          veSluzbe = !veSluzbe;
          let user = null;
          try {
            user = JSON.parse(localStorage.getItem('discordUser'));
          } catch (e) {}
          const username = user ? `${user.username}#${user.discriminator}` : 'Neznámý uživatel';
          const action = veSluzbe ? 'PŘÍCHOD DO SLUŽBY' : 'ODCHOD ZE SLUŽBY';
          const color = veSluzbe ? '#e0ffe0' : '';
          sluzbaBtn.textContent = veSluzbe ? '🕒 Odchod ze služby' : '🕒 Příchod do služby';
          sluzbaBtn.style.background = color;

          // Povolit/zakázat tlačítko Pracovat podle stavu služby
          if (pracovatBtn) pracovatBtn.disabled = !veSluzbe;

          // Odeslání na Discord webhook
          const webhookUrl = 'https://discord.com/api/webhooks/1390989690072727605/IwgaE5140eg1RVJuIgC8hmjGpi-IhC5pYCAzRJqstgtFVkuzQ8YadyR4TWhXC9UysbMv';
          const payload = {
            embeds: [{
              title: `🚦 ${action}`,
              description: `Uživatel **${username}** právě provedl akci: **${action}**.`,
              color: veSluzbe ? 65280 : 16711680,
              timestamp: new Date().toISOString()
            }]
          };
          try {
            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
          } catch (e) {
            console.error('Nepodařilo se odeslat na Discord webhook:', e);
          }

          // 1) PŘÍCHOD DO SLUŽBY
          if (veSluzbe && user) {
            await supabase.from('users_online').upsert({
              username: user.username,
              online: true,
              created: new Date().toISOString()
            });
          }

          // Zápis do Supabase - uživatel odchází ze služby
          if (!veSluzbe && user) {
            await supabase.from('users_online').update({ online: false }).eq('username', user.username);
          }

          // 4) UKONČENÍ SLUŽBY - ZÁPIS ČASU VE SLUŽBĚ
          if (!veSluzbe && user) {
            // Zjisti čas příchodu (ulož si ho při příchodu do služby do localStorage)
            const startTime = localStorage.getItem('serviceStart');
            if (startTime) {
              const minutes = Math.floor((Date.now() - Number(startTime)) / 60000);
              // Získání aktuálního času ve službě
              const { data } = await supabase.from('users_score').select('time_online').eq('username', user.username).single();
              const newTime = (data?.time_online || 0) + minutes;
              await supabase.from('users_score').upsert({
                username: user.username,
                time_online: newTime
              });
              localStorage.removeItem('serviceStart');
            }
          }

          // Při příchodu do služby si ulož čas do localStorage:
          if (veSluzbe) {
            localStorage.setItem('serviceStart', Date.now().toString());
          }
        });
      }
    });
    </script>
    <footer class="footer">
        &copy; 2025 Multi-Cargo Doprava (MCD) &mdash; stránka strojvedoucích
    </footer>
</body>
</html>